name: Sync project status on issue close

on:
  issues:
    types: [closed, reopened]

permissions:
  issues: read

jobs:
  sync-status:
    runs-on: ubuntu-latest
    steps:
      - name: Generate app token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.PROJECT_APP_ID }}
          private-key: ${{ secrets.PROJECT_APP_PRIVATE_KEY }}
          owner: emergent-instruments

      - name: Update project item status
        uses: actions/github-script@v7
        with:
          github-token: ${{ steps.app-token.outputs.token }}
          script: |
            const projectId = 'PVT_kwDOD1h1Qc4BOUxm';
            const fieldId = 'PVTSSF_lADOD1h1Qc4BOUxmzg9D2fw';
            const doneOptionId = '98236657';
            const inProgressOptionId = '47fc9ee4';

            const issue = context.payload.issue;
            const action = context.payload.action;

            // Paginate through project items to find this issue
            let cursor = null;
            let item = null;

            while (!item) {
              const result = await github.graphql(`
                query($owner: String!, $number: Int!, $cursor: String) {
                  organization(login: $owner) {
                    projectV2(number: $number) {
                      items(first: 100, after: $cursor) {
                        nodes {
                          id
                          content {
                            ... on Issue {
                              number
                              repository { name }
                            }
                          }
                        }
                        pageInfo { hasNextPage endCursor }
                      }
                    }
                  }
                }
              `, {
                owner: 'emergent-instruments',
                number: 1,
                cursor,
              });

              const page = result.organization.projectV2.items;
              item = page.nodes.find(i =>
                i.content?.number === issue.number &&
                i.content?.repository?.name === context.repo.repo
              );

              if (!item && page.pageInfo.hasNextPage) {
                cursor = page.pageInfo.endCursor;
              } else {
                break;
              }
            }

            if (!item) {
              console.log(`Issue #${issue.number} not found on project board`);
              return;
            }

            const optionId = action === 'closed' ? doneOptionId : inProgressOptionId;
            const statusLabel = action === 'closed' ? 'Done' : 'In Progress';

            await github.graphql(`
              mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $optionId: String!) {
                updateProjectV2ItemFieldValue(input: {
                  projectId: $projectId
                  itemId: $itemId
                  fieldId: $fieldId
                  value: { singleSelectOptionId: $optionId }
                }) {
                  projectV2Item { id }
                }
              }
            `, {
              projectId,
              itemId: item.id,
              fieldId,
              optionId,
            });

            console.log(`Set issue #${issue.number} to ${statusLabel}`);
